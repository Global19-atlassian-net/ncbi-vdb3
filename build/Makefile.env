# ===========================================================================
#
#                            PUBLIC DOMAIN NOTICE
#               National Center for Biotechnology Information
#
#  This software/database is a "United States Government Work" under the
#  terms of the United States Copyright Act.  It was written as part of
#  the author's official duties as a United States Government employee and
#  thus cannot be copyrighted.  This software/database is freely available
#  to the public for use. The National Library of Medicine and the U.S.
#  Government have not placed any restriction on its use or reproduction.
#
#  Although all reasonable efforts have been taken to ensure the accuracy
#  and reliability of the software and data, the NLM and the U.S.
#  Government do not and cannot warrant the performance or results that
#  may be obtained by using this software or data. The NLM and the U.S.
#  Government disclaim all warranties, express or implied, including
#  warranties of performance, merchantability or fitness for any particular
#  purpose.
#
#  Please cite the author in any work or product based on this material.
#
# ===========================================================================

#
# Common definitions for makefiles in VDB3 build system
#

# load build configuration
# defines OUTDIR, BUILD
CONFIG_FILE = $(TOP)/Makefile.config
ifeq (no, $(shell test -f $(CONFIG_FILE) && echo yes || echo no))
    $(error "*** File '$(CONFIG_FILE)' is missing. Please run `make -C $(TOP) config` ")
endif
include $(CONFIG_FILE)

# full directory paths
MODPATH     ?= $(subst $(TOP)/,,$(CURDIR))

TARGDIR     ?= $(OUTDIR)/$(BUILD)
BINDIR      ?= $(TARGDIR)/bin
LIBDIR      ?= $(TARGDIR)/lib
OBJDIR      ?= $(TARGDIR)/obj/$(MODPATH)
TEST_BINDIR ?= $(TARGDIR)/test-bin

SRCDIR      ?= $(TOP)/$(MODPATH)

# if not set in the config file or on the command line
INSTDIR     ?= /usr/local/ncbi/ncbi-vdb3

#
# compilation settings
#

INCDIRS = $(addprefix -I, $(SRCDIR) $(TOP)/interfaces . ) -I /usr/local/googletest/1.8/src/googletest/include

# default tool parameters
CFLAGS_COMMON += -maes -mavx -pedantic -fmax-errors=4 $(INCDIRS)

ALL_THE_WARNINGS = \
 -Waddress \
 -Waddress-of-packed-member \
 -Waggressive-loop-optimizations \
 -Waligned-new=all \
 -Wall \
 -Walloc-zero \
 -Walloca \
 -Warray-bounds \
 -Warray-bounds=2 \
 -Wattribute-alias=2 \
 -Wattribute-warning \
 -Wattributes \
 -Wbool-compare \
 -Wbool-operation \
 -Wbuiltin-declaration-mismatch \
 -Wbuiltin-macro-redefined \
 -Wcannot-profile \
 -Wcast-align \
 -Wcast-function-type \
 -Wcast-qual \
 -Wcatch-value=3 \
 -Wchar-subscripts \
 -Wclass-conversion \
 -Wclass-memaccess \
 -Wclobbered \
 -Wcomment \
 -Wcomments \
 -Wconditionally-supported \
 -Wconversion \
 -Wconversion-null \
 -Wcoverage-mismatch \
 -Wcpp \
 -Wctor-dtor-privacy \
 -Wno-ctor-dtor-privacy \
 -Wdangling-else \
 -Wdate-time \
 -Wdelete-incomplete \
 -Wdelete-non-virtual-dtor \
 -Wdeprecated \
 -Wdeprecated-copy \
 -Wdeprecated-copy-dtor \
 -Wdeprecated-declarations \
 -Wdisabled-optimization \
 -Wdiv-by-zero \
 -Wdouble-promotion \
 -Wduplicated-branches \
 -Wduplicated-cond \
 -Weffc++ \
 -Wempty-body \
 -Wendif-labels \
 -Wenum-compare \
 -Wexpansion-to-defined \
 -Wno-exit-time-destructors \
 -Werror \
 -Wextra \
 -Wextra-semi \
 -Wfloat-conversion \
 -Wformat \
 -Wformat-contains-nul \
 -Wformat-extra-args \
 -Wformat-nonliteral \
 -Wformat-overflow=2 \
 -Wformat-security \
 -Wformat-signedness \
 -Wformat-truncation=2 \
 -Wformat-y2k \
 -Wformat-zero-length \
 -Wformat=2 \
 -Wframe-address \
 -Wfree-nonheap-object \
 -Whsa \
 -Wif-not-aligned \
 -Wignored-attributes \
 -Wignored-qualifiers \
 -Wimplicit-fallthrough=5 \
 -Winherited-variadic-ctor \
 -Winit-list-lifetime \
 -Winit-self \
 -Winline \
 -Wint-in-bool-context \
 -Wint-to-pointer-cast \
 -Winvalid-memory-model \
 -Winvalid-offsetof \
 -Winvalid-pch \
 -Wjump-misses-init \
 -Wliteral-suffix \
 -Wlogical-not-parentheses \
 -Wlogical-op \
 -Wlto-type-mismatch \
 -Wmain \
 -Wmaybe-uninitialized \
 -Wmemset-elt-size \
 -Wmemset-transposed-args \
 -Wmisleading-indentation \
 -Wmissing-attributes \
 -Wmissing-braces \
 -Wmissing-declarations \
 -Wmissing-field-initializers \
 -Wmissing-declarations \
 -Wmissing-field-initializers \
 -Wmissing-format-attribute \
 -Wmissing-include-dirs \
 -Wmissing-noreturn \
 -Wmissing-profile \
 -Wmultichar \
 -Wmultiple-inheritance \
 -Wmultistatement-macros \
 -Wnarrowing \
 -Wno-keyword-macro \
 -Wno-range-loop-analysis \
 -Wno-deprecated-declarations \
 -Wno-c++2a-compat \
 -Wno-float-equal \
 -Wno-long-long \
 -Wno-namespaces \
 -Wno-padded \
 -Wno-switch-enum \
 -Wno-covered-switch-default \
 -Wno-weak-vtables \
 -Wno-system-headers \
 -Wno-templates \
 -Wno-undef \
 -Wno-unused \
 -Wnoexcept \
 -Wnoexcept-type \
 -Wnon-template-friend \
 -Wnon-virtual-dtor \
 -Wnonnull \
 -Wnonnull-compare \
 -Wnonportable-cfstrings \
 -Wnormalized \
 -Wnull-dereference \
 -Wodr \
 -Wold-style-cast \
 -Wopenmp-simd \
 -Woverflow \
 -Woverlength-strings \
 -Woverloaded-virtual \
 -Wpacked \
 -Wpacked-bitfield-compat \
 -Wpacked-not-aligned \
 -Wparentheses \
 -Wpedantic \
 -Wpessimizing-move \
 -Wplacement-new=2 \
 -Wpmf-conversions \
 -Wpointer-arith \
 -Wpointer-compare \
 -Wpragmas \
 -Wprio-ctor-dtor \
 -Wpsabi \
 -Wredundant-decls \
 -Wredundant-move \
 -Wregister \
 -Wreorder \
 -Wrestrict \
 -Wreturn-local-addr \
 -Wreturn-type \
 -Wscalar-storage-order \
 -Wsequence-point \
 -Wshadow \
 -Wshadow-compatible-local \
 -Wshadow-local \
 -Wshadow-compatible-local \
 -Wshadow-local \
 -Wshadow=compatible-local \
 -Wshadow=global \
 -Wshadow=local \
 -Wshift-count-negative \
 -Wshift-count-overflow \
 -Wshift-negative-value \
 -Wshift-overflow=2 \
 -Wsign-compare \
 -Wsign-conversion \
 -Wsign-promo \
 -Wsized-deallocation \
 -Wsizeof-array-argument \
 -Wsizeof-pointer-div \
 -Wsizeof-pointer-memaccess \
 -Wstack-protector \
 -Wstrict-aliasing=3 \
 -Wstrict-null-sentinel \
 -Wstrict-overflow=5 \
 -Wstringop-overflow=4 \
 -Wstringop-truncation \
 -Wsubobject-linkage \
 -Wsuggest-attribute=cold \
 -Wsuggest-attribute=const \
 -Wsuggest-attribute=format \
 -Wsuggest-attribute=malloc \
 -Wsuggest-attribute=noreturn \
 -Wsuggest-attribute=pure \
 -Wsuggest-final-methods \
 -Wsuggest-final-types \
 -Wsuggest-override \
 -Wswitch \
 -Wswitch-bool \
 -Wswitch-default \
 -Wswitch-unreachable \
 -Wsync-nand \
 -Wsynth \
 -Wtautological-compare \
 -Wterminate \
 -Wtrampolines \
 -Wtrigraphs \
 -Wtype-limits \
 -Wuninitialized \
 -Wunknown-pragmas \
 -Wunreachable-code \
 -Wunsafe-loop-optimizations \
 -Wunused \
 -Wunused-but-set-parameter \
 -Wunused-but-set-variable \
 -Wunused-const-variable=2 \
 -Wunused-function \
 -Wunused-label \
 -Wunused-local-typedefs \
 -Wunused-macros \
 -Wunused-parameter \
 -Wunused-result \
 -Wunused-value \
 -Wunused-variable \
 -Wunused-value \
 -Wunused-variable \
 -Wuseless-cast \
 -Wvarargs \
 -Wvariadic-macros \
 -Wvector-operation-performance \
 -Wvirtual-inheritance \
 -Wvirtual-move-assign \
 -Wvla \
 -Wvolatile-register-var \
 -Wwrite-strings \
 -Wzero-as-null-pointer-constant


# generate source file dependencies
CFLAGS_COMMON += -MD
# pick up dependencies from object directory
include $(wildcard *.d)

# adjust settings for build
ifeq (dbg,$(BUILD))
	CFLAGS_COMMON += -g -DDEBUG
endif

CFLAGS	= $(CFLAGS_COMMON) -std=gnu11
CPFLAGS = $(CFLAGS_COMMON) -std=gnu++11
LDFLAGS =

CC = gcc -c $(CFLAGS)
CP = g++ -c $(CPFLAGS)
LP = g++ $(LDFLAGS)

AR = ar rc

OBJX = o
LOBX = pic.o

VPATH = $(SRCDIR)

# include rules now that VPATH is fully set
include $(TOP)/build/Makefile.rules

# make reissue command
MAKE_CMD = $(MAKE) TOP=$(TOP) SRCDIR=$(SRCDIR) -C $(OBJDIR) -f $(SRCDIR)/Makefile

# these targets are defined in the leaf Makefiles
.PHONY: default test

include $(TOP)/build/Makefile.targets

